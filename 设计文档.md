# Reddit热门帖子转图片服务设计文档

## 1. 项目概述

### 1.1 项目目标
实现一个HTTP接口服务，接收Reddit热门帖子的JSON数据，生成精美的卡片图片，返回图片URL集合。

### 1.2 核心功能
- 接收包含Reddit帖子和评论数据的JSON
- 将文字信息渲染成竖版3:4比例的精美卡片
- 每个帖子生成2-4张图片
- 返回生成图片的URL集合

## 2. 技术架构设计

### 2.1 技术栈选择

#### 后端框架：Node.js + Express.js
**选择理由：**
- 处理JSON数据天然优势
- 异步处理能力强，适合图片生成的IO密集型操作
- 部署简单，生态成熟

#### 图片生成技术：
todo

#### 模板系统：自定义Canvas模板引擎
**技术方案：**
```
todo
```

### 2.2 项目结构
```
n8n-service/
├── src/
│   ├── controllers/          # 控制器
│   │   └── cardController.js
│   ├── services/             # 业务逻辑
│   │   ├── imageGenerator.js # 图片生成服务
│   │   └── templateEngine.js # 模板引擎
│   ├── templates/            # 卡片模板
│   │   ├── mainCard.js       # 主帖模板
│   │   └── commentCard.js    # 评论模板
│   ├── utils/                # 工具函数
│   │   ├── textUtils.js      # 文字处理
│   │   └── canvasUtils.js    # Canvas工具
│   ├── assets/               # 静态资源
│   │   ├── fonts/            # 字体文件
│   │   └── icons/            # 图标资源
│   └── app.js                # 应用入口
├── public/                   # 生成的图片存储
├── package.json
└── README.md
```

## 3. 图片生成方案设计

### 3.1 模板系统架构

#### 模板类型设计
1. **主帖卡片模板**
   - 标题区域（中英文）
   - 正文区域（中英文）
   - 点赞数显示
   - Reddit图标和样式

2. **评论卡片模板**
   - 评论内容（中英文）
   - 作者信息
   - 点赞数
   - 层级关系视觉表现

#### 模板配置结构
```javascript
const templateConfig = {
  canvas: {
    width: 750,        // 3:4比例
    height: 1000,
    backgroundColor: '#ffffff'
  },
  layout: {
    header: { height: 80 },
    content: { 
      padding: 40,
      lineHeight: 1.5,
      maxLines: 15
    },
    footer: { height: 60 }
  },
  typography: {
    title: { fontSize: 28, fontWeight: 'bold', color: '#1a1a1a' },
    body: { fontSize: 20, fontWeight: 'normal', color: '#333333' },
    meta: { fontSize: 16, fontWeight: 'normal', color: '#666666' }
  }
}
```

### 3.2 Canvas渲染流程

#### 渲染步骤
1. **初始化Canvas**
   ```javascript
   const canvas = createCanvas(750, 1000);
   const ctx = canvas.getContext('2d');
   ```

2. **背景和布局绘制**
   - 设置背景色
   - 绘制Reddit图标
   - 创建内容区域边界

3. **文字内容渲染**
   - 字体加载和设置
   - 文字换行和排版计算
   - 中英文混排处理
   - 文字密度控制

4. **样式装饰**
   - 添加阴影效果
   - 绘制分割线
   - 点赞数图标和数字

5. **图片导出**
   ```javascript
   const buffer = canvas.toBuffer('image/png');
   const filename = `reddit_card_${postId}_${timestamp}_${index}.png`;
   ```

### 3.3 文字排版算法

#### 自动换行算法
```javascript
function wrapText(ctx, text, maxWidth) {
  const words = text.split('');
  const lines = [];
  let currentLine = '';
  
  for (let char of words) {
    const testLine = currentLine + char;
    const metrics = ctx.measureText(testLine);
    
    if (metrics.width > maxWidth && currentLine !== '') {
      lines.push(currentLine);
      currentLine = char;
    } else {
      currentLine = testLine;
    }
  }
  lines.push(currentLine);
  return lines;
}
```

#### 内容分页逻辑
- 根据文字密度智能分页
- 保证每张图片内容完整性
- 优先级：标题 > 正文 > 评论

## 4. HTTP接口设计

### 4.1 API规范

#### 接口地址
```
POST /api/generate-cards
```

#### 请求体
```json
{
  "postList": [
    {
      "id": "reddit_post_id",
      "title": "Original title",
      "title_polish_zh": "润色后的中文标题",
      "title_zh": "中文标题",
      "subreddit": "subreddit_name",
      "selftext": "Post content...",
      "selftext_zh": "翻译后的正文",
      "created": 1234567890,
      "ups": 100,
      "name": "post_name",
      "summary_zh": "用中文写的一段总结",
      "commentList": [
        {
          "author": "comment_author",
          "body": "Comment content...",
          "body_zh": "翻译后的评论",
          "parent_id": "parent_comment_id",
          "ups": 50,
          "icon_img": "avatar_url"
        }
      ]
    }
  ]
}
```

#### 响应体
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "postId": "reddit_post_id_1",
        "imageUrls": [
          "http://domain.com/images/reddit_card_post1_1234567890_1.png",
          "http://domain.com/images/reddit_card_post1_1234567890_2.png"
        ],
        "imageCount": 2
      },
      {
        "postId": "reddit_post_id_2", 
        "imageUrls": [
          "http://domain.com/images/reddit_card_post2_1234567890_1.png",
          "http://domain.com/images/reddit_card_post2_1234567890_2.png",
          "http://domain.com/images/reddit_card_post2_1234567890_3.png"
        ],
        "imageCount": 3
      }
    ],
    "totalPosts": 2,
    "totalImages": 5,
    "generatedAt": "2024-01-01T12:00:00Z"
  }
}
```

### 4.2 数据处理流程

```
接收JSON → 数据验证 → 内容分析 → 模板选择 → 图片生成 → 文件存储 → 返回URL
```

## 5. 部署和扩展方案

### 5.1 文件存储策略
- 本地存储：生成的图片保存到 `public/images/` 目录
- 文件命名：`reddit_card_{postId}_{timestamp}_{index}.png`
  - `{postId}`: Reddit帖子的唯一ID
  - `{timestamp}`: 生成时间戳
  - `{index}`: 该帖子的图片序号（1, 2, 3...）
- 定期清理：设置图片过期时间，定期删除旧文件

### 5.2 URL代理方案

#### 方案一：程序内代理（推荐）
```javascript
app.use('/images', express.static('public/images'));
```

#### 方案二：Nginx代理
```nginx
location /images/ {
    root /path/to/n8n-service/public;
    expires 7d;
    add_header Cache-Control "public, immutable";
}
```

### 5.3 性能优化
- 字体文件预加载
- Canvas对象池化
- 图片生成队列处理
- 缓存常用模板

### 5.4 错误处理
- 数据格式验证
- 图片生成失败重试
- 文件系统错误处理
- 内存使用监控

## 6. 开发计划

### 6.1 开发阶段
1. **Phase 1**: 基础框架搭建和简单模板
2. **Phase 2**: 完善模板系统和文字排版
3. **Phase 3**: 样式优化和错误处理
4. **Phase 4**: 性能优化和部署配置

### 6.2 技术风险
- 中文字体渲染兼容性
- 大量图片生成时的内存管理
- 高并发场景下的性能表现

这个设计采用了您建议的"模板 - 填充文字 - Canvas导出图片"的技术路线，能够满足Reddit帖子转图片的所有需求。
